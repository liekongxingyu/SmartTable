# SmartTable 数据流图

## 快照创建流程

```
┌─────────────────┐
│  AI 回复完成    │
│  或手动编辑     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 获取当前消息索引│
│ currentIdx = 15 │
└────────┬────────┘
         │
         ▼
┌──────────────────────────┐
│ createSnapshot(chatData, │
│   messageIndex: 15)      │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 深拷贝当前表格数据        │
│ snapshot = {             │
│   messageIndex: 15,      │
│   tables: {...},         │
│   timestamp: "..."       │
│ }                        │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 添加到快照数组            │
│ snapshots.push(snapshot) │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 修改表格数据              │
│ chatData.tables[key] =   │
│   newData                │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ Storage.saveChatData()   │
│ 写入 jsonl 文件          │
└──────────────────────────┘
```

## 回滚流程

```
┌──────────────────┐
│ 用户删除消息 #12  │
│ 或重新生成回复    │
└────────┬─────────┘
         │
         ▼
┌──────────────────────────┐
│ MESSAGE_DELETED 事件触发  │
│ targetMessageIndex = 12  │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ rollbackToSnapshot(12)   │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 从后往前遍历快照数组      │
│ snapshots = [            │
│   {idx: 5, ...},         │
│   {idx: 10, ...},        │
│   {idx: 15, ...}  ← 跳过  │
│ ]                        │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 找到快照@10               │
│ (10 < 12 < 15)           │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 恢复表格数据              │
│ chatData.tables =        │
│   snapshot@10.tables     │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ 删除后续快照              │
│ 删除快照@15               │
│ 保留快照@5, @10           │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ Storage.saveChatData()   │
│ 更新 jsonl 文件          │
└────────┬─────────────────┘
         │
         ▼
┌──────────────────────────┐
│ toastr.info("回滚成功")  │
└──────────────────────────┘
```

## 数据结构演变示例

### 初始状态 (消息 #0)

```json
{
  "tables": {},
  "snapshots": []
}
```

### 消息 #5 - AI 更新任务表

```json
{
  "tables": {
    "tasks": [{ "id": 1, "title": "任务A" }]
  },
  "snapshots": [
    {
      "messageIndex": 5,
      "tables": {}, // 更新前是空的
      "timestamp": "2026-01-30T10:00:00Z"
    }
  ]
}
```

### 消息 #10 - AI 更新事件表

```json
{
  "tables": {
    "tasks": [{ "id": 1, "title": "任务A" }],
    "events": [{ "id": 1, "desc": "事件X" }]
  },
  "snapshots": [
    {
      "messageIndex": 5,
      "tables": {},
      "timestamp": "2026-01-30T10:00:00Z"
    },
    {
      "messageIndex": 10,
      "tables": {
        "tasks": [{ "id": 1, "title": "任务A" }]
      },
      "timestamp": "2026-01-30T10:15:00Z"
    }
  ]
}
```

### 消息 #15 - AI 更新任务表

```json
{
  "tables": {
    "tasks": [
      { "id": 1, "title": "任务A" },
      { "id": 2, "title": "任务B" } // 新增
    ],
    "events": [{ "id": 1, "desc": "事件X" }]
  },
  "snapshots": [
    {
      "messageIndex": 5,
      "tables": {},
      "timestamp": "2026-01-30T10:00:00Z"
    },
    {
      "messageIndex": 10,
      "tables": {
        "tasks": [{ "id": 1, "title": "任务A" }]
      },
      "timestamp": "2026-01-30T10:15:00Z"
    },
    {
      "messageIndex": 15,
      "tables": {
        "tasks": [{ "id": 1, "title": "任务A" }],
        "events": [{ "id": 1, "desc": "事件X" }]
      },
      "timestamp": "2026-01-30T10:30:00Z"
    }
  ]
}
```

### 用户删除消息 #12 → 自动回滚到快照@10

```json
{
  "tables": {
    "tasks": [{ "id": 1, "title": "任务A" }], // 恢复到只有任务A
    "events": [{ "id": 1, "desc": "事件X" }] // 事件表保留（在消息#10已存在）
  },
  "snapshots": [
    {
      "messageIndex": 5,
      "tables": {},
      "timestamp": "2026-01-30T10:00:00Z"
    },
    {
      "messageIndex": 10,
      "tables": {
        "tasks": [{ "id": 1, "title": "任务A" }]
      },
      "timestamp": "2026-01-30T10:15:00Z"
    }
    // 快照@15 被删除
  ]
}
```

## jsonl 文件最终写入格式

```jsonl
{
  "user_name": "You",
  "character_name": "AI",
  "create_date": "1706678400000",
  "chat_metadata": {
    "smart_table_v2": {
      "tables": {
        "tasks": [
          {
            "id": 1,
            "title": "任务A"
          }
        ],
        "events": [
          {
            "id": 1,
            "desc": "事件X"
          }
        ]
      },
      "lastUpdatedIndices": {
        "tasks": 10,
        "events": 10
      },
      "baseFloor": 10,
      "snapshots": [
        {
          "messageIndex": 5,
          "tables": {},
          "lastUpdatedIndices": {},
          "baseFloor": 0,
          "timestamp": "2026-01-30T10:00:00Z"
        },
        {
          "messageIndex": 10,
          "tables": {
            "tasks": [
              {
                "id": 1,
                "title": "任务A"
              }
            ]
          },
          "lastUpdatedIndices": {
            "tasks": 5
          },
          "baseFloor": 5,
          "timestamp": "2026-01-30T10:15:00Z"
        }
      ]
    }
  }
}
```

**关键点：**

- 所有快照数据都在 `chat_metadata.smart_table_v2.snapshots` 中
- 每次 `Storage.saveChatData()` 都会更新整个 `smart_table_v2` 对象
- SillyTavern 的 `saveMetadata()` API 负责最终写入 jsonl 文件
