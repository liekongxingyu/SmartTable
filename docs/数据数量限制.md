# 数据数量限制功能说明

## 📌 功能概述

SmartTable 插件现在支持为每个表设置最大保留数量，超过限制时会自动清理旧数据，保持表格整洁高效。

---

## 🧹 清理策略

### 1. **有主键字段的表**（推荐）

当表格定义了字段时，第一个字段会作为主键（唯一标识符）：

```
清理步骤：
1️⃣ 去重：相同主键的数据，只保留最新的那条
2️⃣ 限制：如果去重后仍超过最大数量，删除最旧的数据
```

**示例：**

```
原始数据 (maxRows=3):
[
  {id: "1", status: "done"},
  {id: "2", status: "pending"},
  {id: "1", status: "完成"},     ← 重复的 id=1
  {id: "3", status: "new"},
  {id: "4", status: "waiting"}
]

清理后:
[
  {id: "1", status: "完成"},      ← 保留最新的 id=1
  {id: "2", status: "pending"},
  {id: "3", status: "new"}        ← 只保留3条
]
```

### 2. **无主键字段的表**

直接截取最新的 N 条数据：

```javascript
finalData = rows.slice(0, maxRows);
```

---

## ⚙️ 配置方式

### 界面配置

1. 打开 SmartTable 管理面板
2. 进入 **"策略"** 标签页 (⚡图标)
3. 找到对应的表格卡片
4. 设置 **"最大保留数量"**：
   - **0** = 不限制（默认）
   - **> 0** = 限制为该数量

![配置示例]

```
┌─────────────────────────────────┐
│ 🔬 任务表                        │
├─────────────────────────────────┤
│ 状态同步频率          │  最大保留数量  │
│ [  3  ]              │  [ 10  ]    │
│ (每3条消息)           │ (0=不限制)   │
└─────────────────────────────────┘
```

### 代码配置

如果直接修改 schema：

```javascript
{
  id: "tasks",
  title: "任务表",
  fields: [...],
  freq: 3,
  maxRows: 10  // 新增：最大保留10条
}
```

---

## 🔄 触发时机

数据清理会在以下情况**自动触发**：

1. ✅ **AI 自动更新表格后**
2. ✅ **手动添加新行后**（待实现）
3. ✅ **手动编辑行后**（待实现）

**重要：** 清理在保存数据之前执行，因此快照中保存的也是清理后的数据。

---

## 📊 清理报告

每次清理都会在控制台输出详细报告：

```
🧹 [DataCleaner] 数据清理报告:
   [任务表] 基于主键清理：去重删除 2 条，超限删除 3 条
   [人物表] 基于主键清理：去重删除 1 条
   [大纲表] 简单截取：删除 5 条旧数据
```

---

## 🎯 使用建议

### 适合设置限制的场景

| 表格类型     | 建议限制 | 原因                     |
| ------------ | -------- | ------------------------ |
| **短期任务** | 10-20    | 完成的任务不需要长期保留 |
| **对话事件** | 30-50    | 只关注最近的互动         |
| **状态记录** | 5-10     | 状态变更频繁，只需最新   |

### 不建议设置限制的场景

| 表格类型     | 建议   | 原因                 |
| ------------ | ------ | -------------------- |
| **重要情报** | 不限制 | 关键信息需要永久保留 |
| **人物关系** | 不限制 | 关系网络需要完整性   |
| **故事大纲** | 不限制 | 长篇创作需要全局视角 |

---

## 🛡️ 安全机制

### 回滚兼容

由于清理发生在快照创建**之前**，回滚时恢复的是**清理后**的数据，保证了数据一致性。

### 去重优先

清理器总是**先去重，再限制数量**，确保不会因为重复数据浪费配额。

### 位置保留

清理后的数据保持原有顺序，新数据仍然在前面。

---

## 💡 高级技巧

### 1. 动态调整限制

可以根据聊天进度动态调整 `maxRows`：

- 初期：不限制，收集大量数据
- 中期：设置 50，保持信息密度
- 后期：设置 20，聚焦核心内容

### 2. 配合 AI 提示词

```
针对任务表的 Prompt:
"只记录状态为'进行中'或'等待'的任务，已完成的任务不要记录"
```

配合 `maxRows=10`，可以让 AI 自动过滤，减少清理压力。

### 3. 主键设计

选择合适的第一个字段作为主键：

- ✅ 任务表：`id` 或 `title`
- ✅ 人物表：`name`
- ✅ 事件表：`timestamp` 或 `event_id`

---

## 🚀 性能影响

- **清理耗时**: < 5ms（单表100条数据）
- **内存开销**: 临时 Map，清理后释放
- **存储减少**: 有效控制 jsonl 文件大小

---

## 📝 后续优化方向

1. 支持手动触发全局清理
2. 支持按时间戳清理（保留最近N天）
3. 支持自定义清理规则（Lambda表达式）
4. 清理前弹出确认对话框（可选）

---

## ⚠️ 注意事项

1. **主键去重是基于第一个字段**，请确保字段顺序正确
2. **清理是不可逆的**，回滚只能回到清理后的状态
3. **手动编辑不会触发清理**，需等下次 AI 更新
4. **设置 maxRows=1** 不会导致表格为空，至少保留1条

---

**总结：数据数量限制功能通过解耦的 DataCleaner 模块实现，自动在保存前清理数据，保持表格整洁高效！** 🎉
